/*! For license information please see smf.player.min.js.LICENSE */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("SMF",[],t):"object"==typeof exports?exports.SMF=t():e.SMF=t()}("undefined"!=typeof self?self:this,(function(){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var n=t[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,i),n.l=!0,n.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(s,n,function(t){return e[t]}.bind(null,n));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=11)}([function(e,t,i){"use strict";i.d(t,"a",(function(){return n})),i.d(t,"c",(function(){return a})),i.d(t,"b",(function(){return r}));class s{constructor(e,t,i){this.subtype=e,this.deltaTime=t,this.time=i}}class n extends s{constructor(e,t,i,s,n,a){super(e,t,i),this.channel=s,this.parameter1=n,this.parameter2=a}}class a extends s{constructor(e,t,i,s){super(e,t,i),this.data=s}}class r extends s{constructor(e,t,i,s){super(e,t,i),this.data=s}}},function(e,t,i){"use strict";t.a={version:"0.3.4",date:"2020-01-13T02:21:59.690Z"}},function(e,t,i){"use strict";i.d(t,"a",(function(){return n}));var s=i(0);class n{constructor(e={}){this.timeDivision=0|e.timeDivision||96,this.channel=0|e.channel,this.timeOffset=0|e.timeOffset,this.PATTERN=/[a-glnortv<>][+#-]?\d*\.?&?/g,this.NOTE_TABLE={c:0,d:2,e:4,f:5,g:7,a:9,b:11},this.MINIM=2*this.timeDivision,this.SEMIBREVE=4*this.timeDivision,this.VELOCITY_MAGNIFICATION=7,this.mml=e.mml,this.events=[],this.plainEvents=[],this.endTime=0,this.noteOffNegativeOffset=1,this.ignoreTempo=!1|e.igonreTempo,this.maxOctave=8|e.maxOctave,this.minOctave=0|e.minOctave,this.octaveMode=0|e.octaveMode,this.minNote=12|e.minNote,this.maxNote=98|e.minNote,this.parse()}parse(){let e=[];try{e=this.mml.toLowerCase().match(this.PATTERN)}catch(e){return}if(!e)return;let t=this.timeOffset,i=this.timeDivision,n=0,a=8,r=4,o=!1;const c=[];for(const h of e){let e=0|i,u="",l=0;if(h.match(/([lotv<>])([1-9][0-9]*|0?)(\.?)(&?)/))switch(u=RegExp.$1.toLowerCase(),l=0|RegExp.$2,o&&"&"!==RegExp.$4&&(o=!1,c.push(new s.a("NoteOff",0,t-this.noteOffNegativeOffset,this.channel,n))),u){case"l":l>=1&&l<=this.MINIM&&(i=Math.floor(this.SEMIBREVE/l),"."===RegExp.$3&&(i=Math.floor(1.5*i)));break;case"o":l>=this.minOctave&&l<=this.maxOctave&&(r=l);break;case"t":c.push(new s.b("SetTempo",0,t,[Math.floor(6e7/l)]));break;case"v":l>=0&&l<=15&&(a=l);break;case"<":r=r<=this.minOctave?this.minOctave:r-1;break;case">":r=r>=this.maxOctave?this.maxOctave:r+1}else if(h.match(/([a-gn])([+#-]?)([0-9]*)(\.?)(&?)/)){let i=0;switch(u=RegExp.$1.toLowerCase(),l=0|RegExp.$3,"n"===u?i=l:(l>=1&&l<=this.MINIM&&(e=Math.floor(this.SEMIBREVE/l)),"."===RegExp.$4&&(e=Math.floor(1.5*e)),2!==this.octaveMode&&(i=12*r+this.NOTE_TABLE[u],"+"===RegExp.$2||"#"===RegExp.$2?i++:"-"===RegExp.$2&&i--)),this.octaveMode){case 1:for(;i<this.minNote;)i+=12;for(;i>this.maxNote;)i-=12;i+=12;break;case 2:i=this.maxNote;break;default:i+=12}o?i!==n&&(c.push(new s.a("NoteOff",0,t-this.noteOffNegativeOffset,this.channel,n)),o=!1):c.push(new s.a("NoteOn",0,t,this.channel,i,a*this.VELOCITY_MAGNIFICATION)),t+=e,"&"===RegExp.$5?(o=!0,n=i):(o=!1,c.push(new s.a("NoteOff",0,t-this.noteOffNegativeOffset,this.channel,i)))}else h.match(/R([0-9]*)(\.?)/i)&&(l=0|RegExp.$1,l>=1&&l<=this.MINIM&&(e=Math.floor(this.SEMIBREVE/l)),"."===RegExp.$2&&(e=Math.floor(1.5*e)),t+=e)}this.events=c,this.endTime=t}getGmDrum(e){return e}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return o}));var s=i(2),n=i(7),a=i.n(n),r=i(0);class o{constructor(e,t={}){const i=String.fromCharCode.apply("",new Uint16Array(e));this.input=a.a.parse(i),this.tracks=[],this.plainTracks=[],this.numberOfTracks=1,this.timeDivision=t.timeDivision||96}parse(){this.parseHeader(),this.parseTracks(),this.toPlainTrack()}parseHeader(){this.encoder=new TextEncoder("shift_jis");const e=this.input.infomation;this.title=e.title||"",this.type=e.auther||"",this.timeDivision=0|e.timeBase||96,this.mmsInstTable=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,65,66,67,68,69,70,71,72,73,74,75,76,18];const t=[];t.push(new r.c("SystemExclusive",0,0,[126,127,9,1])),t.push(new r.b("SequenceTrackName",0,0,[this.title])),t.push(new r.b("CopyrightNotice",0,0,[this.author])),t.push(new r.b("TimeSignature",0,0,[0|e.rythmNum||4,0|e.rythmBase||4,0,0])),t.push(new r.b("EndOfTrack",0,0)),this.tracks.push(t),delete this.input.infomation,delete this.input["mms-file"]}parseTracks(){const e=this.input;let t=[];const i=[];let n=0;for(const a in e)if(e.hasOwnProperty(a)){const o=[e[a].ch0_mml,e[a].ch1_mml,e[a].ch2_mml],c=Number(e[a].panpot)+64;t.push(new r.b("InsturumentName",0,48,[e[a].name])),t.push(new r.a("ProgramChange",0,96,n,0|this.mmsInstTable[e[a].instrument])),t.push(new r.a("ControlChange",0,154,n,10,c));for(let e=0;e<o.length;e++){const a=new s.a({timeDivision:this.timeDivision,channel:n,timeOffset:386,mml:o[e]});t=t.concat(a.events),i.push(a.endTime)}n++,t.concat(new r.b("EndOfTrack",0,Math.max(i))),this.tracks.push(t)}this.numberOfTracks=this.tracks.length}toPlainTrack(){for(let e=0;e<this.tracks.length;e++){let t=[],i=[];const s=this.tracks[e];for(let e=0;e<s.length;e++){const t=s[e];let n;if(t instanceof r.a)switch(t.subtype){case"NoteOn":n=0===t.parameter2?new Uint8Array([128|t.channel,t.parameter1,t.parameter2]):new Uint8Array([144|t.channel,t.parameter1,t.parameter2]);break;case"NoteOff":n=new Uint8Array([128|t.channel,t.parameter1,t.parameter2]);break;case"ControlChange":n=new Uint8Array([176|t.channel,t.parameter1,t.parameter2]);break;case"ProgramChange":n=new Uint8Array([192|t.channel,t.parameter1])}else if(t instanceof r.b){const e=this.encoder.encode(t.data);switch(t.subtype){case"TextEvent":n=new Uint8Array([255,1].concat(e));break;case"SequenceTrackName":n=new Uint8Array([255,3].concat(e));break;case"CopyrightNotice":n=new Uint8Array([255,2].concat(e));break;case"InsturumentName":n=new Uint8Array([255,4].concat(e));break;case"SetTempo":n=new Uint8Array([255,81].concat(e));break;case"TimeSignature":n=new Uint8Array([255,88].concat(e));break;case"EndOfTrack":n=new Uint8Array([255,47])}}else t instanceof r.c&&(n=new Uint8Array([240,5].concat(t.data)));i=i.concat(n)}t=t.concat(i),this.plainTracks[e]=t}}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(e,t={}){this.input=e,this.ip=t.index||0,this.length=t.length||e.length-this.ip,this.chunkList,this.offset=this.ip,this.padding=void 0===t.padding||t.padding,this.bigEndian=void 0!==t.bigEndian&&t.bigEndian}parse(){const e=this.length+this.offset;for(this.chunkList=[];this.ip<e;)this.parseChunk()}parseChunk(){const e=this.input;let t,i=this.ip;this.chunkList.push(new n(String.fromCharCode(e[i++],e[i++],e[i++],e[i++]),t=this.bigEndian?(e[i++]<<24|e[i++]<<16|e[i++]<<8|e[i++])>>>0:(e[i++]|e[i++]<<8|e[i++]<<16|e[i++]<<24)>>>0,i)),i+=t,this.padding&&1==(i-this.offset&1)&&i++,this.ip=i}getChunk(e){const t=this.chunkList[e];return void 0===t?null:t}getNumberOfChunks(){return this.chunkList.length}}class n{constructor(e,t,i){this.type=e,this.size=t,this.offset=i}}},function(e,t,i){"use strict";i.r(t),i.d(t,"default",(function(){return r}));var s=i(0),n=i(1),a=i(4);class r{constructor(e,t={}){t.padding=!1,t.bigEndian=!0,this.input=e,this.ip=t.index||0,this.chunkIndex=0,this.riffParser_=new a.a(e,t),this.formatType=0,this.numberOfTracks=0,this.timeDivision=0,this.tracks=[],this.plainTracks=[],this.version=n.a.version,this.build=n.a.build}parse(){let e=0,t=0;for(this.riffParser_.parse(),this.parseHeaderChunk(),e=0,t=this.numberOfTracks;e<t;++e)this.parseTrackChunk()}parseHeaderChunk(){const e=this.riffParser_.getChunk(this.chunkIndex++),t=this.input;let i=e.offset;if(!e||"MThd"!==e.type)throw new Error("invalid header signature");this.formatType=t[i++]<<8|t[i++],this.numberOfTracks=t[i++]<<8|t[i++],this.timeDivision=t[i++]<<8|t[i++]}parseTrackChunk(){const e=this.riffParser_.getChunk(this.chunkIndex++),t=this.input;let i,n,a=e.offset,r=0,o=0,c=0,h=0,u=-1,l=-1,p=0,m=0,d=0,f=0,b=0;const g=()=>{let e=0,i=0;do{i=t[a++],e=e<<7|127&i}while(0!=(128&i));return e};if(!e||"MTrk"!==e.type)throw new Error("invalid header signature");r=e.offset+e.size;const k=[],y=[];for(;a<r;){o=g(),m+=o,d=a,b=t[a++],c=b>>4&15,h=15&b,c<8?(c=u,h=l,b=u<<4|l,a--,d--):(u=c,l=h);const e=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(c){case 8:case 9:case 10:case 11:case 13:case 14:i=new s.a(e[c],o,m,h,t[a++],t[a++]);break;case 12:i=new s.a(e[c],o,m,h,t[a++]);break;case 15:switch(h){case 0:if(p=g(),247!==t[a+p-1])throw new Error("invalid SysEx event");i=new s.c("SystemExclusive",o,m,t.subarray(a,(a+=p)-1));break;case 7:p=g(),i=new s.c("SystemExclusive(F7)",o,m,t.subarray(a,a+=p));break;case 15:switch(c=t[a++],p=g(),c){case 0:i=new s.b("SequenceNumber",o,m,[t[a++],t[a++]]);break;case 1:i=new s.b("TextEvent",o,m,[String.fromCharCode.apply(null,t.subarray(a,a+=p))]);break;case 2:i=new s.b("CopyrightNotice",o,m,[String.fromCharCode.apply(null,t.subarray(a,a+=p))]);break;case 3:i=new s.b("SequenceTrackName",o,m,[String.fromCharCode.apply(null,t.subarray(a,a+=p))]);break;case 4:i=new s.b("InstrumentName",o,m,[String.fromCharCode.apply(null,t.subarray(a,a+=p))]);break;case 5:i=new s.b("Lyrics",o,m,[String.fromCharCode.apply(null,t.subarray(a,a+=p))]);break;case 6:i=new s.b("Marker",o,m,[String.fromCharCode.apply(null,t.subarray(a,a+=p))]);break;case 7:i=new s.b("CuePoint",o,m,[String.fromCharCode.apply(null,t.subarray(a,a+=p))]);break;case 32:i=new s.b("MidiChannelPrefix",o,m,[t[a++]]);break;case 47:i=new s.b("EndOfTrack",o,m,[]);break;case 81:i=new s.b("SetTempo",o,m,[t[a++]<<16|t[a++]<<8|t[a++]]);break;case 84:i=new s.b("SmpteOffset",o,m,[t[a++],t[a++],t[a++],t[a++],t[a++]]);break;case 88:i=new s.b("TimeSignature",o,m,[t[a++],t[a++],t[a++],t[a++]]);break;case 89:i=new s.b("KeySignature",o,m,[t[a++],t[a++]]);break;case 127:i=new s.b("SequencerSpecific",o,m,[t.subarray(a,a+=p)]);break;default:i=new s.b("Unknown",o,m,[c,t.subarray(a,a+=p)])}}break;default:throw new Error("invalid status")}f=a-d,n=t.subarray(d,d+f),n[0]=b,i instanceof s.a&&"NoteOn"===i.subtype&&0===i.parameter2&&(i.subtype=e[8],n=new Uint8Array([128|i.channel,i.parameter1,i.parameter2])),y.push(n),k.push(i)}this.tracks.push(k),this.plainTracks.push(y)}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(2),n=i(3),a=i(0);class r extends n.a{constructor(e,t={}){super(e,t),this.input=String.fromCharCode.apply("",new Uint16Array(e)).split(/\r\n|\r|\n/),this.tracks=[],this.plainTracks=[],this.numberOfTracks=1,this.timeDivision=t.timeDivision||96}parse(){this.parseHeader(),this.parseTracks(),this.toPlainTrack()}parseHeader(){this.encoder=new TextEncoder("utf-8");const e=["mml-track","name","program","songProgram","panpot"],t={};let i=-1;t.track=[];for(let s=0;s<this.input.length;s++){const n=this.input[s].trim();if(0===s){if("[mml-score]"!==n)throw new Error("Not MabiIcco File.");continue}const[a,r]=n.split("=");e.includes(a)?"mml-track"===a?(i++,t.track[i]={},t.track[i].mml=r):t.track[i][a]="name"===a?r:0|r:t[a]=r}this.title=t.title||"",this.author=t.author||"";const s=""!==t.tempo?t.tempo.split("T"):[0,120];this.timeDivision=96,this.tempo=0|s[1];const n=t.time.split("/"),r=[];r.push(new a.c("SystemExclusive",0,0,[126,127,9,1])),r.push(new a.b("SequenceTrackName",0,0,[this.title])),r.push(new a.b("CopyrightNotice",0,0,[this.author])),r.push(new a.b("TimeSignature",0,0,[0|n[0]||4,0|n[1]||4,0,0])),r.push(new a.b("SetTempo",0,0,[Math.floor(6e7/this.tempo)])),r.push(new a.b("EndOfTrack",0,0)),this.tracks.push(r),this.input=t.track}parseTracks(){let e=[];const t=[];for(let i=0;i<this.input.length;i++){const n=this.input[i];if(!n.mml.match(/^(?:MML@)(.*)/gm))continue;const r=RegExp.$1.split(",");e.push(new a.b("InsturumentName",0,48,[n.name])),e.push(new a.a("ProgramChange",0,96,i,n.program)),-1!==n.songProgram&&e.push(new a.a("ProgramChange",0,112,15,n.songProgram)),e.push(new a.a("ControlChange",0,154,i,10,n.panpot));for(let a=0;a<n.mml.length;a++){let o=i;if(3===a&&-1!==n.songProgram&&(o=15),void 0===r[a])continue;const c=new s.a({timeDivision:this.timeDivision,channel:o,timeOffset:386,mml:r[a],igonoreTempo:1===o});e=e.concat(c.events),t.push(c.endTime)}e.concat(new a.b("EndOfTrack",0,Math.max(t))),this.tracks.push(e)}this.numberOfTracks=this.tracks.length}}},function(e,t){t.parse=t.decode=function(e){var t={},i=t,n=null,a=/^\[([^\]]*)\]$|^([^=]+)(=(.*))?$/i;return e.split(/[\r\n]+/g).forEach((function(e,s,o){if(e&&!e.match(/^\s*[;#]/)){var c=e.match(a);if(c){if(void 0!==c[1])return n=r(c[1]),void(i=t[n]=t[n]||{});var h=r(c[2]),u=!c[3]||r(c[4]);switch(u){case"true":case"false":case"null":u=JSON.parse(u)}h.length>2&&"[]"===h.slice(-2)&&(h=h.substring(0,h.length-2),i[h]?Array.isArray(i[h])||(i[h]=[i[h]]):i[h]=[]),Array.isArray(i[h])?i[h].push(u):i[h]=u}}})),Object.keys(t).filter((function(e,i,n){if(!t[e]||"object"!=typeof t[e]||Array.isArray(t[e]))return!1;var a=s(e),r=t,o=a.pop(),c=o.replace(/\\\./g,".");return a.forEach((function(e,t,i){r[e]&&"object"==typeof r[e]||(r[e]={}),r=r[e]})),(r!==t||c!==o)&&(r[c]=t[e],!0)})).forEach((function(e,i,s){delete t[e]})),t},t.stringify=t.encode=function e(t,n){var r=[],o="";"string"==typeof n?n={section:n,whitespace:!1}:(n=n||{}).whitespace=!0===n.whitespace;var c=n.whitespace?" = ":"=";Object.keys(t).forEach((function(e,s,n){var h=t[e];h&&Array.isArray(h)?h.forEach((function(t){o+=a(e+"[]")+c+a(t)+"\n"})):h&&"object"==typeof h?r.push(e):o+=a(e)+c+a(h)+i})),n.section&&o.length&&(o="["+a(n.section)+"]"+i+o);return r.forEach((function(a,r,c){var h=s(a).join("\\."),u=(n.section?n.section+".":"")+h,l=e(t[a],{section:u,whitespace:n.whitespace});o.length&&l.length&&(o+=i),o+=l})),o},t.safe=a,t.unsafe=r;var i="undefined"!=typeof process&&"win32"===process.platform?"\r\n":"\n";function s(e){return e.replace(/\1/g,"LITERAL\\1LITERAL").replace(/\\\./g,"").split(/\./).map((function(e){return e.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,"")}))}function n(e){return'"'===e.charAt(0)&&'"'===e.slice(-1)||"'"===e.charAt(0)&&"'"===e.slice(-1)}function a(e){return"string"!=typeof e||e.match(/[=\r\n]/)||e.match(/^\[/)||e.length>1&&n(e)||e!==e.trim()?JSON.stringify(e):e.replace(/;/g,"\\;").replace(/#/g,"\\#")}function r(e,t){if(!n(e=(e||"").trim())){for(var i=!1,s="",a=0,r=e.length;a<r;a++){var o=e.charAt(a);if(i)-1!=="\\;#".indexOf(o)?s+=o:s+="\\"+o,i=!1;else{if(-1!==";#".indexOf(o))break;"\\"===o?i=!0:s+=o}}return i&&(s+="\\"),s.trim()}"'"===e.charAt(0)&&(e=e.substr(1,e.length-2));try{e=JSON.parse(e)}catch(e){}return e}},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(2),n=i(3),a=i(0);class r extends n.a{constructor(e,t={}){super(e,t),this.encoder=new TextEncoder("utf-8");const i=(new DOMParser).parseFromString(String.fromCharCode.apply("",new Uint16Array(e)),"text/xml");this.input=i.querySelectorAll("ms2 > *"),this.tracks=[],this.plainTracks=[],this.numberOfTracks=1,this.timeDivision=t.timeDivision||96}parse(){this.parseTracks(),this.toPlainTrack()}parseTracks(){let e=[];const t=[];for(let i=0;i<this.input.length;i++){const n=new s.a({timeDivision:this.timeDivision,channel:0,mml:this.input[i].textContent.trim(),ignoreTempo:!1});e=e.concat(n.events),t.push(n.endTime)}e.concat(new a.b("EndOfTrack",0,Math.max(t))),this.tracks.push(e)}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return s}));class s{constructor(e,t={}){this.input=e,this.ip=t.index||0,this.timeDivision=t.timeDivision||48,this.header,this.dataInformation,this.tracks}parse(){this.parseHeader(),this.parseDataInformation(),this.parseTracks()}parseHeader(){const e=this.input;let t=this.ip;const i=this.header={},s=String.fromCharCode(e[t++],e[t++],e[t++],e[t++]);if("melo"!==s)throw new Error("invalid MFi signature:"+s);i.fileLength=(e[t++]<<24|e[t++]<<16|e[t++]<<8|e[t++])>>>0,i.trackOffset=(e[t++]<<16|e[t++])+t,i.dataMajorType=e[t++],i.dataMinorType=e[t++],i.numberOfTracks=e[t++],this.ip=t}parseDataInformation(){const e=this.input;let t=this.ip;const i=this.dataInformation={copy:null,date:null,exst:null,note:null,prot:null,sorc:null,titl:null,trac:null,vers:null};let s,n;for(;t<this.header.trackOffset;)switch(s=String.fromCharCode(e[t++],e[t++],e[t++],e[t++]),n=e[t++]<<8|e[t++],s){case"titl":case"copy":case"vers":case"date":case"prot":i[s]=String.fromCharCode.apply(null,e.subarray(t,t+=n));break;case"sorc":i[s]=e[t++];break;case"note":i[s]=e[t++]<<8|e[t++];break;case"exst":break;default:i[s]=e.subarray(t,t+=n)}this.ip=t}parseTracks(){const e=this.input;let t,i,s,n,a,r,o=this.ip;const c=this.tracks=[];let h,u,l;const p=()=>{const t=e[o++]<<8|e[o++],i=o+t,s=[];let n;if(1!==e[o++])throw new Error("invalid EditInstrument const value:"+e[o-1]);for(;o<i;)n={},n.part=e[o++]>>4&3,n.modulator={ML:e[o]>>5,VIV:e[o]>>4&1,EG:e[o]>>3&1,SUS:e[o]>>2&1,RR:(3&e[o++])<<2|e[o]>>6,DR:e[o]>>4&15,AR:(3&e[o++])<<2|e[o]>>6,SL:e[o]>>4&15,TL:(3&e[o++])<<4|e[o]>>4,WF:e[o]>>3&1,FB:7&e[o++]},n.carrier={ML:e[o]>>5,VIV:e[o]>>4&1,EG:e[o]>>3&1,SUS:e[o]>>2&1,RR:(3&e[o++])<<2|e[o]>>6,DR:e[o]>>4&15,AR:(3&e[o++])<<2|e[o]>>6,SL:e[o]>>4&15,TL:(3&e[o++])<<4|e[o]>>4,WF:e[o]>>3&1,FB:7&e[o++]},n.octaveSelect=3&e[o++],s.push(n);return s},m=()=>{if(1!==e[o++])throw new Error("invalid Vibrato const value:"+e[o-1]);return{part:e[o++]>>5&3,switch:e[o++]>>6}},d=()=>{const t=e[o++]<<8|e[o++],i=o+t;if(17!==e[o++])throw new Error("invalid DeviceSpecific const value:"+e[o-1]);return{data:e.subarray(o,o+=i-o)}};for(u=0,l=this.header.numberOfTracks;u<l;++u){if(t=String.fromCharCode(e[o++],e[o++],e[o++],e[o++]),"trac"!==t)throw new Error("invalid track signature:"+t);for(i=e[o++]<<24|e[o++]<<16|e[o++]<<8|e[o++],s=o+i,h=c[u]=[];o<s;){if(r={key:null,length:null,octaveShift:null,subType:null,type:null,value:{},velocity:null,voice:null},r.deltaTime=deltaTime=e[o++],n=e[o++],255!==n)r.type="note",r.subType="Note",r.voice=n>>6,r.key=63&n,noteLength=r.length=e[o++],1===this.dataInformation.note&&(a=e[o++],r.velocity=a>>2,r.octaveShift=3&a);else switch(r.type="meta",n=e[o++],n>>4){case 11:switch(15&n){case 0:r.subType="MasterVolume",r.value=e[o++];break;case 10:r.subType="DrumScale",r.value={channel:e[o]>>3&7,drum:1&e[o++]};break;default:throw new Error("unknown message type:"+n.toString(16))}break;case 12:r.subType="SetTempo",r.value={timeBase:7==(7&n)?NaN:Math.pow(2,7&n)*(0==(8&n)?6:15),tempo:e[o++]};break;case 13:switch(15&n){case 0:r.subType="Point",r.value=e[o++];break;case 13:r.subType="Loop",r.value={id:e[o]>>6,count:e[o]>>2&15,point:3&e[o++]};break;case 14:r.subType="Nop",r.value=e[o++];break;case 15:r.subType="EndOfTrack",r.value=e[o++];break;default:throw new Error("unkwnon message type:"+n.toString(16))}break;case 14:switch(15&n){case 0:r.subType="InstrumentLowPart",r.value={part:e[o]>>6,instrument:63&e[o++]};break;case 1:r.subType="InstrumentHighPart",r.value={part:e[o]>>6,instrument:1&e[o++]};break;case 2:r.subType="Volume",r.value={part:e[o]>>6,volume:63&e[o++]};break;case 3:r.subType="Valance",r.value={part:e[o]>>6,valance:63&e[o++]};break;case 4:r.subType="PitchBend",r.value={part:e[o]>>6,value:63&e[o++]};break;case 5:r.subType="ChannelAssign",r.value={part:e[o]>>6,channel:63&e[o++]};break;case 6:r.subType="VolumeChange",r.value={part:e[o]>>6,volume:(63&e[o++])<<26>>26};break;case 7:r.subType="PitchBendRange",r.value={part:e[o]>>6,value:63&e[o++]};break;case 8:case 9:r.subType="MasterCoarseTuning",r.value={part:e[o]>>6,value:63&e[o++]};break;case 10:r.subType="Modulation",r.value={part:e[o]>>6,depth:63&e[o++]};break;default:throw new Error("unkwnon message type:"+n.toString(16))}break;case 15:switch(15&n){case 0:r.subType="EditInstrument",r.value=p();break;case 1:r.subType="Vibrato",r.value=m();break;case 15:r.subType="DeviceSpecific",r.value=d();break;default:throw new Error("unkwnon message type:"+n.toString(16))}break;default:throw new Error("unkwnon message type:"+n.toString(16))}h.push(r)}o=s}this.ip=o}convertToMidiTracks(){this.timeDivision;const e=[],t=[],i=this.tracks;let s,n,a,r,o,c,h,u,l,p,m,d,f;const b=[];let g;for(p=0;p<16;++p)t[p]=[],b[p]=0;for(p=0,m=i.length;p<m;++p){for(s=i[p],r=[],o=c=d=0,f=s.length;d<f;++d)switch(n=s[d],o+=n.deltaTime,n.id=c,n.time=o,n.subType){case"Nop":break;case"Note":r[c++]=n,r[c]={id:c,type:"internal",subType:"NoteOff",time:o+n.length,key:n.key,voice:n.voice,velocity:n.velocity,octaveShift:n.octaveShift},c++;break;case"InstrumentHighPart":if(a=n,n=s[++d],"InstrumentLowPart"!==n.subType)throw new Error("broken instrument");r[c]={id:c,type:"internal",subType:"ProgramChange",time:o,part:n.value.part,instrument:a.value.instrument<<6|n.value.instrument},c++;break;default:r[c++]=n}for(r.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.id>t.id?1:e.id<t.id?-1:0),e[p]=[],o=d=0,f=r.length;d<f;++d){switch(n=r[d],o=n.time,n.subType){case"Note":h=this.applyOctaveShift(n.key+45,n.octaveShift),g=4*p+n.voice,9===g&&(h-=10),t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(144|g,h,2*n.velocity));break;case"NoteOff":h=this.applyOctaveShift(n.key+45,n.octaveShift),g=4*p+n.voice,9===g&&(h-=10),t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(128|g,h,2*n.velocity));break;case"ProgramChange":g=4*p+n.part,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(192|g,n.instrument));break;case"SetTempo":u=288e7/(n.value.tempo*n.value.timeBase),g=0,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(255,81,3,u>>16&255,u>>8&255,255&u));break;case"Loop":u=n.value.count,l="LOOP_"+(0===n.value.point?"START":"END")+"=ID:"+n.value.id+",COUNT:"+(0===u?-1:u),g=0,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat([255,6,l.length],l.split("").map(e=>e.charCodeAt(0))));break;case"MasterVolume":u=n.value,g=0,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(240,7,127,127,4,1,u,u,247));break;case"Modulation":g=4*p+n.value.part,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(176|g,1,2*n.value.depth));break;case"Volume":g=4*p+n.value.part,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(176|g,7,2*n.value.volume));break;case"Valance":g=4*p+n.value.part,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(176|g,10,2*(n.value.valance-32)+64));break;case"PitchBend":g=4*p+n.value.part,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(224|g,2*n.value.value,2*n.value.value));break;case"PitchBendRange":g=4*p+n.value.part,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(176|g,100,0),[0,176|g,101,0],[0,176|g,6,2*n.value.value]);break;case"MasterCoarseTuning":g=4*p+n.value.part,t[g].push(this.deltaTimeToByteArray(o-b[g]).concat(176|g,100,0),[0,176|g,101,2],[0,176|g,6,2*n.value.value]);break;default:continue}b[g]=n.time}}return this.toSMF(t)}applyOctaveShift(e,t){const i=[0,12,-24,-12];if(void 0!==i[t])return e+i[t];throw new Error("invalid OctaveShift value:"+t)}toSMF(e){let t,i,s,n,a,r,o=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];if(void 0!==this.dataInformation.copy){let t=function(e){let t;const i=e.length,s=new Array(i);for(t=0;t<i;++t)s[t]=e.charCodeAt(t);return s}(this.dataInformation.copy);n=t.length,t=[0,255,2].concat(this.deltaTimeToByteArray(n),t),e[0].unshift(t)}for(s=0,n=e.length;s<n;++s){const n=e[s];for(i=[],a=0,r=n.length;a<r;++a)Array.prototype.push.apply(i,n[a]);r=i.length,t=[77,84,114,107,r>>24&255,r>>16&255,r>>8&255,255&r],o=o.concat(t,i)}return new Uint8Array(o)}deltaTimeToByteArray(e){const t=[];for(;e>=128;)t.unshift(127&e|(0===t.length?0:128)),e>>>=7;return t.unshift(e|(0===t.length?0:128)),t}}},function(e,t,i){"use strict";i.d(t,"a",(function(){return r}));var s=i(2),n=i(0),a=i(3);class r extends a.a{constructor(e,t={}){super(e,t)}parse(){this.parseHeader(),this.parseTracks(),this.toPlainTrack()}parseHeader(){const e=this.input.Settings;this.encoder=new TextEncoder(e.Encoding||"shift_jis"),this.title=e.Title||"",this.author=e.Source||"",this.timeDivision=0|e.TimeBase||32;const t=[];t.push(new n.c("SystemExclusive",0,0,[126,127,9,1])),t.push(new n.b("SequenceTrackName",0,0,[this.title])),t.push(new n.b("CopyrightNotice",0,0,[this.author])),t.push(new n.b("TextEvent",0,0,[e.Memo||""])),t.push(new n.b("TimeSignature",0,0,[0|e.TimeSignatureNN||4,0|e.TimeSignatureDD||4,0,0])),t.push(new n.b("EndOfTrack",0,0)),this.tracks.push(t),delete this.input["3MLE EXTENSION"],delete this.input.Settings}parseTracks(){const e=this.input,t=[],i=[],a=[];for(const t in e)e.hasOwnProperty(t)&&(t.match(/^Channel(\d+)$/i)&&(i[(0|RegExp.$1)-1]=Object.keys(e[t]).join("").replace(/\/\*([^*]|\*[^\/])*\*\//g,"")),t.match(/^ChannelProperty(\d+)$/i)&&(a[(0|RegExp.$1)-1]={name:e[t].Name||`Channel${(0|RegExp.$1)-1}`,instrument:0|e[t].Patch,panpot:0|e[t].Pan}));const r=[];for(const e in i)i.hasOwnProperty(e)&&(void 0!==a[e]?r[e]={mml:i[e],name:a[e].name,instrument:a[e].instrument||0,panpot:a[e].panpot||64}:r[e]={mml:i[e],name:`Channel${ch}`,instrument:0,panpot:64});for(const e in r)if(r.hasOwnProperty(e)){const i=0|e;let a=[];if(""===r[e].mml)continue;a.push(new n.b("InsturumentName",0,48,[r[e].name])),a.push(new n.a("ProgramChange",0,96,i,r[e].instrument)),a.push(new n.a("ControlChange",0,154,i,10,r[e].panpot));const o=new s.a({timeDivision:this.timeDivision,channel:i,timeOffset:386,mml:r[e].mml});a=a.concat(o.events),t.push(o.endTime),a.concat(new n.b("EndOfTrack",0,Math.max(t))),this.tracks.push(a)}this.numberOfTracks=this.tracks.length}}},function(e,t,i){"use strict";i.r(t),i.d(t,"Player",(function(){return u}));var s=i(6),n=i(3),a=i(8),r=i(1),o=i(9),c=i(5),h=i(10);class u{constructor(e="#wml"){this.tempo=5e5,this.webMidiLink,this.resume,this.pause=!0,this.ready=!1,this.position=0,this.track=[],this.timer=0,this.sequence={},this.enableCC111Loop=!1,this.enableFalcomLoop=!1,this.enableMFiLoop=!1,this.enableLoop=!1,this.tempoRate=1,this.masterVolume=16383,this.textEvent="",this.sequenceName="",this.copyright="",this.lyrics="",this.webMidiLink=null,this.length=0,this.time=0,this.timeTotal,this.loaded=0,this.window=window,this.target=this.window.document.querySelector(e),this.version=r.a.version,this.build=r.a.build}setCC111Loop(e){this.enableCC111Loop=e}setFalcomLoop(e){this.enableFalcomLoop=e}setMFiLoop(e){this.enableMFiLoop=e}setLoop(e){this.enableLoop=e}stop(){let e;if(this.pause=!0,this.resume=Date.now(),this.webMidiLink)for(e=0;e<16;++e)this.webMidiLink.contentWindow.postMessage("midi,b"+e.toString(16)+",78,0","*")}getWebMidiLink(){return this.webMidiLink}init(){this.stop(),this.initSequence(),this.pause=!0,this.track=null,this.resume=-1,this.text=null,this.sequence=null,this.sequenceName=null,this.copyright=null,this.lyrics=null,this.textEvent=null,this.length=0,this.position=0,this.time=0,this.timeTotal=0,this.window.clearTimeout(this.timer);const e=this;this.ready?this.sendInitMessage():this.window.addEventListener("message",t=>{"link,ready"===t.data&&e.sendInitMessage()},!1)}initSequence(){this.tempo=5e5,this.position=0,this.sendInitMessage(),this.pause=!1}play(){const e=this;if(!this.webMidiLink)throw new Error("WebMidiLink not found");this.ready?this.track&&(this.length=this.track.length,this.track instanceof Array&&this.position>=this.length&&(this.position=0),this.playSequence()):this.window.addEventListener("message",t=>{"link,ready"===t.data&&(e.ready=!0,e.webMidiLink.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px",e.playSequence())},!1)}ended(){player.window.postMessage("endoftrack","*")}sendInitMessage(){const e=this.webMidiLink.contentWindow;let t;for(t=0;t<16;++t)e.postMessage("midi,b"+t.toString(16)+",128,0","*"),e.postMessage("midi,b"+t.toString(16)+",07,64","*"),e.postMessage("midi,b"+t.toString(16)+",0a,40","*"),e.postMessage("midi,e"+t.toString(16)+",00,40","*"),e.postMessage("midi,b"+t.toString(16)+",64,00","*"),e.postMessage("midi,b"+t.toString(16)+",65,00","*"),e.postMessage("midi,b"+t.toString(16)+",06,02","*"),e.postMessage("midi,b"+t.toString(16)+",26,00","*");this.sendGmReset()}setWebMidiLink(e="./wml.html"){const t=this,i=e=>{if("string"==typeof e.data){const i=e.data.split(",");"link"===i[0]&&("ready"===i[1]?(t.ready=!0,t.loaded=100,t.setMasterVolume(t.masterVolume)):"progress"===i[1]&&(t.loaded=Math.round(i[2]/i[3]*1e4)))}};if("string"==typeof e){this.webMidiLink&&this.webMidiLink.parentNode.removeChild(this.webMidiLink),this.target.firstChild&&this.target.removeChild(this.target.firstChild);const t=this.webMidiLink=this.window.document.createElement("iframe");t.src=e,t.className="wml",this.target.appendChild(t),this.window.addEventListener("message",i,!1);const s=()=>{t.style.height=this.webMidiLink.contentWindow.document.body.scrollHeight+"px"};this.window.addEventListener("load",s,!1);let n=0;this.window.addEventListener("resize",()=>{n>0&&clearTimeout(n),n=setTimeout(s,100)},!1)}else this.webMidiLink.addEventListener("message",i,!1)}setMasterVolume(e){this.masterVolume=e,this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(127&e).toString(16)).substr(-2),("0"+(e>>7&127).toString(16)).substr(-2),"7f"].join(","),"*")}setTempoRate(e){this.tempoRate=e}playSequence(){const e=this,t=this.sequence.timeDivision,i=this.track,s=this.webMidiLink.contentWindow;let n=this.position||0;const a=[],r=()=>{const o=i[n].time||0,c=i.length;let h,u,l,p=Date.now();if(e.pause)e.resume=Date.now()-e.resume;else{do{switch(h=i[n].event,h.subtype){case"TextEvent":e.textEvent=h.data[0];break;case"Lyrics":e.lyrics=h.data[0];break;case"Maker":if(e.enableFalcomLoop)switch(h.data[0]){case"A":a[0]={pos:n};break;case"B":if(a[0]&&"number"==typeof a[0].pos)return n=a[0].pos,e.timer=e.window.setTimeout(r,0),void(e.position=n)}if(e.enableMFiLoop&&(u=h.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/),u))if("START"===u[1])a[0|u[2]]=a[u[2]]||{pos:n,count:0|u[3]};else if("END"===u[1]&&e.enableMFiLoop){if(l=a[0|u[2]],0!==l.count)return l.count>0&&l.count--,n=l.pos,e.timer=e.window.setTimeout(r,0),void(e.position=n);a[0|u[2]]=null}break;case"SetTempo":e.tempo=h.data[0]}"ControlChange"===h.subtype&&111===h.parameter1&&(a[0]={pos:n}),s.postMessage(i[n++].webMidiLink,"*")}while(n<c&&i[n].time===o);n<c?(p=Date.now()-p,e.timer=e.window.setTimeout(r,e.tempo/(1e3*t)*(i[n].time-o-p)*(1/e.tempoRate))):(e.ended(),e.pause=!0,e.enableCC111Loop&&a[0]&&"number"==typeof a[0].pos?n=a[0].pos:e.enableLoop&&(e.initSequence(),e.playSequence())),e.position=n,e.time=o}};this.pause?(this.timer=e.window.setTimeout(r,this.resume),this.pause=!1,this.resume=-1):this.timer=e.window.setTimeout(r,this.tempo/1e3*t*this.track[0].time||0)}loadMidiFile(e){const t=new c.default(e);this.init(),t.parse(),this.mergeMidiTracks(t)}loadMldFile(e){const t=new o.a(e);this.init(),t.parse(),this.mergeMidiTracks(t.convertToMidiTracks())}loadMs2MmlFile(e){const t=new a.a(e);this.init(),t.parse(),this.mergeMidiTracks(t)}loadMakiMabiSequenceFile(e){const t=new n.a(e);this.init(),t.parse(),this.mergeMidiTracks(t)}load3MleFile(e){const t=new h.a(e);this.init(),t.parse(),this.mergeMidiTracks(t)}loadMabiIccoFile(e){const t=new s.a(e);this.init(),t.parse(),this.mergeMidiTracks(t)}mergeMidiTracks(e){const t=this.track=[],i=e.tracks,s=new Array(i.length),n=e.plainTracks;let a,r,o,c,h;for(r=0,o=i.length;r<o;++r)s[r]=0;for(r=0,o=i.length;r<o;++r)for(a=i[r],c=0,h=a.length;c<h;++c)0!==e.formatType&&0!==r||("SequenceTrackName"===a[c].subtype?this.sequenceName=a[c].data[0]:"CopyrightNotice"===a[c].subtype&&(this.copyright=a[c].data[0])),t.push({track:r,eventId:c,time:a[c].time,event:a[c],webMidiLink:"midi,"+Array.prototype.map.call(n[r][c],e=>e.toString(16)).join(",")});t.sort((e,t)=>e.time>t.time?1:e.time<t.time?-1:e.track>t.track?1:e.track<t.track?-1:e.eventId>t.eventId?1:e.eventId<t.eventId?-1:0),this.timeTotal=t.slice(-1)[0].time,this.sequence=e}getSequenceName(){return this.sequenceName}getCopyright(){return this.copyright}getLyrics(){return this.lyrics}getTextEvent(){return this.textEvent}getPosition(){return this.position}setPosition(e){this.position=e}getLength(){return this.length}sendGmReset(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,F0,7E,7F,09,01,F7","*")}sendAllSoundOff(){this.webMidiLink&&this.webMidiLink.contentWindow.postMessage("midi,b0,78,0","*")}getTime(e){const t=this.tempo/6e6*e,i=Math.floor(t/3600),s=t%3600,n=Math.floor(s/60),a=s%60,r=Math.ceil(a);return i+":"+("00"+n).slice(-2)+":"+("00"+r).slice(-2)}}}])}));